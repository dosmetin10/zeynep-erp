<!doctype html><html><head><meta charset='utf-8'><title>Modül</title>
<style>
body{font-family:Tahoma,Arial;margin:0;background:#0f88ad;color:#000}.win{margin:14px;border:1px solid #6d9fbe;background:#d8eef8;box-shadow:0 8px 18px rgba(0,0,0,.2)}
.head{background:linear-gradient(#4ba8de,#2b79b2);color:#fff;padding:6px 8px;font-size:22px;display:flex;justify-content:space-between;align-items:center}.head button{background:#d91b1b;color:#fff;border:0;padding:2px 10px;font-size:18px;cursor:pointer}
.inner{padding:8px}.flex{display:flex;gap:8px}.left{width:46%}.right{width:54%}.box{border:1px solid #9ab5c9;background:#f4f4f4}.box h4{margin:0;background:#e7edf2;padding:4px 6px;border-bottom:1px solid #b8c7d4;font-size:18px}
.row{display:flex;gap:8px;align-items:center;margin:4px 0} input,select,button{font-size:18px;padding:5px}button{border:1px solid #8ea6b7;background:#efefef;cursor:pointer}button.primary{background:#0b88d5;color:#fff;border-color:#0b5f97}
table{width:100%;border-collapse:collapse;background:#fff}th,td{border:1px solid #b9c7d3;padding:4px;font-size:17px}.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}.status{margin-top:6px;border:1px solid #9ab5c9;background:#fff;padding:6px;font-weight:bold}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center}.modal{width:980px;background:#b9eced;border:2px solid #2ebac2;box-shadow:0 8px 30px rgba(0,0,0,.35)}
.pdf-links a{display:inline-block;margin-right:8px;padding:6px 10px;background:#fff;border:1px solid #8ea6b7;text-decoration:none;color:#000}
</style></head><body>
<div class='win'><div class='head'><span id='title'>MODÜL</span><button id='close'>×</button></div><div class='inner' id='screen'></div></div>
<div class='modal-bg' id='salesModal'><div class='modal'><div class='head'><span>SATIŞ İŞLEMİ</span><button onclick="salesModal.style.display='none'">×</button></div><div class='inner'>
<div class='row'><label>Cari Kod</label><input id='mCust' style='width:160px'><label>Stok ID</label><input id='mItem' type='number' style='width:120px'><label>Miktar</label><input id='mQty' type='number' step='0.01' style='width:110px'><label>Fiyat</label><input id='mPrice' type='number' step='0.01' style='width:110px'><label>Ödeme</label><select id='mPay'><option value='cash'>Nakit</option><option value='bank'>Banka</option><option value='credit'>Vadeli</option></select><button class='primary' id='addLine'>Ekle</button></div>
<table id='mTable'><tr><th>Stok</th><th>Miktar</th><th>Fiyat</th><th>KDV%</th><th>Tutar</th></tr></table>
<div class='row'><div class='status'>Ara Toplam: <span id='mSub'>0.00</span> TL | KDV: <span id='mVat'>0.00</span> TL | Genel Toplam: <span id='mTotal'>0.00</span> TL</div></div>
<div class='row'><button class='primary' id='saveSale'>İŞLEMİ KAYDET</button><div class='pdf-links'><a id='salePdf' target='_blank' href='#'>FATURA YAZDIR</a><a id='dispatchPdf' target='_blank' href='#'>İRSALİYE YAZDIR</a><a id='collectionPdf' target='_blank' href='#'>MAKBUZ YAZDIR</a></div></div>
</div></div></div>
<script>
const name=new URLSearchParams(location.search).get('name')||'Cari'; title.textContent=name.toUpperCase(); close.onclick=()=>{if(window.top!==window.self){window.frameElement?.closest('.panel')?.remove()}else window.close()};
const api=async(u,o)=>{const r=await fetch(u,{headers:{'Content-Type':'application/json'},...o});const d=await r.json().catch(()=>({}));if(!r.ok) throw new Error(d.error?.reason||d.error||JSON.stringify(d));return d};
const esc=s=>String(s??''); let salesLines=[],lastCollectionId=0;
function simpleList(mod,endpoint,cols,pdfBase=null){screen.innerHTML=`<div class='box'><h4>${mod}</h4><div class='inner'><table id='t'></table></div></div>`;api(endpoint).then(d=>{const rows=d.rows||d; t.innerHTML='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+(pdfBase?'<th>PDF</th>':'')+'</tr>'+rows.map(r=>`<tr>${cols.map(c=>`<td>${esc(r[c])}</td>`).join('')}${pdfBase?`<td><a target="_blank" href="${pdfBase}/${r.id}/pdf">PDF</a></td>`:''}</tr>`).join('')})}
function calcTotals(){const sub=salesLines.reduce((a,b)=>a+b.qty*b.price,0),vat=sub*0.2,total=sub+vat; mSub.textContent=sub.toFixed(2);mVat.textContent=vat.toFixed(2);mTotal.textContent=total.toFixed(2)}
addLine.onclick=()=>{const itemId=Number(mItem.value),qty=Number(mQty.value),price=Number(mPrice.value); if(!itemId||qty<=0||price<=0) return alert('Stok, miktar, fiyat girin'); salesLines.push({itemId,qty,price,vatRate:0.2}); mTable.innerHTML='<tr><th>Stok</th><th>Miktar</th><th>Fiyat</th><th>KDV%</th><th>Tutar</th></tr>'+salesLines.map(l=>`<tr><td>${l.itemId}</td><td>${l.qty}</td><td>${l.price}</td><td>20</td><td>${(l.qty*l.price).toFixed(2)}</td></tr>`).join(''); calcTotals();};
saveSale.onclick=async()=>{if(!mCust.value||!salesLines.length) return alert('Cari ve satır zorunlu'); const sale=await api('/api/sales',{method:'POST',body:JSON.stringify({customerCode:mCust.value,paymentMethod:mPay.value,lines:salesLines})}); const dis=await api('/api/dispatch-notes',{method:'POST',body:JSON.stringify({customerCode:mCust.value,itemId:salesLines[0].itemId,qty:salesLines[0].qty,kind:'Satış İrsaliyesi'})}); salePdf.href='/api/sales/'+sale.id+'/pdf'; dispatchPdf.href='/api/dispatch-notes/'+dis.id+'/pdf'; if(lastCollectionId) collectionPdf.href='/api/collections/'+lastCollectionId+'/pdf'; alert('Satış ve irsaliye kaydedildi');};

async function cariScreen(){screen.innerHTML=`<div class='flex'><div class='left'><div class='box'><h4>Cari Hesap Arama</h4><div class='inner'><div class='row'><label>Arama</label><input id='q' style='flex:1'><button id='findBtn'>Ara</button></div><table id='cariTable'><tr><th>Cari Kodu</th><th>Ünvanı</th></tr></table></div></div></div><div class='right'><div class='box'><h4>Cari Hesap Bilgileri</h4><div class='inner'><div class='toolbar'><button id='newCari'>Cari Ekle</button><button class='primary' id='saveCari'>Kaydet</button><button id='btnSatis'>SATIŞ</button><button id='btnTah'>TAHSİLAT</button></div><div class='row'><label style='width:120px'>Cari Kodu:</label><input id='code' style='width:160px'></div><div class='row'><label style='width:120px'>Ünvanı:</label><input id='uname' style='flex:1'></div><div class='row'><label style='width:120px'>Şehir:</label><input id='city' style='width:220px'></div></div></div></div></div><div class='box' style='margin-top:8px'><h4>Cari Hareketleri</h4><div class='inner'><table id='movTable'><tr><th>Tarih</th><th>İşlem</th><th>Yöntem</th><th>Ref</th><th>Tutar</th></tr></table></div></div><div class='status'>BAKİYE: <span id='balance'>0.00</span> TL</div>`;
  async function loadCari(){const d=await api(`/api/customers?page=1&pageSize=100&q=${encodeURIComponent(q.value||'')}`); cariTable.innerHTML='<tr><th>Cari Kodu</th><th>Ünvanı</th></tr>'+d.rows.map(r=>`<tr data-code='${esc(r.code)}'><td>${esc(r.code)}</td><td>${esc(r.name)}</td></tr>`).join(''); if(!code.value){code.value=(await api('/api/codes/next?type=customer')).code;}}
  async function loadMov(){if(!code.value) return; const d=await api('/api/customers/'+encodeURIComponent(code.value)+'/movements'); movTable.innerHTML='<tr><th>Tarih</th><th>İşlem</th><th>Yöntem</th><th>Ref</th><th>Tutar</th></tr>'+d.rows.map(r=>`<tr><td>${esc(r.date)}</td><td>${esc(r.type)}</td><td>${esc(r.method)}</td><td>${esc(r.ref_id)}</td><td>${Number(r.amount||0).toFixed(2)}</td></tr>`).join(''); balance.textContent=d.rows.reduce((a,b)=>a+(b.type==='TAHSILAT'?-Number(b.amount):Number(b.amount)),0).toFixed(2)}
  findBtn.onclick=loadCari; newCari.onclick=async()=>{code.value=(await api('/api/codes/next?type=customer')).code;uname.value='';city.value=''}; saveCari.onclick=async()=>{await api('/api/customers',{method:'POST',body:JSON.stringify({code:code.value,name:uname.value,type:'customer',city:city.value})}); await loadCari(); await loadMov();};
  cariTable.onclick=(e)=>{const tr=e.target.closest('tr[data-code]'); if(!tr) return; const t=tr.querySelectorAll('td'); code.value=t[0].textContent; uname.value=t[1].textContent; loadMov();};
  btnSatis.onclick=()=>{if(!code.value) return alert('Önce cari seçin'); mCust.value=code.value; salesLines=[]; mTable.innerHTML='<tr><th>Stok</th><th>Miktar</th><th>Fiyat</th><th>KDV%</th><th>Tutar</th></tr>'; calcTotals(); salesModal.style.display='flex';};
  btnTah.onclick=async()=>{if(!code.value) return alert('Önce cari seçin'); const amount=prompt('Tahsilat tutarı'); if(!amount) return; const r=await api('/api/collections',{method:'POST',body:JSON.stringify({customerCode:code.value,amount:Number(amount),method:'cash'})}); lastCollectionId=r.id; collectionPdf.href='/api/collections/'+r.id+'/pdf'; await loadMov();};
  await loadCari();
}
async function stokScreen(){screen.innerHTML=`<div class='box'><h4>Stok Kartları</h4><div class='inner'><div class='row'><label>Kod</label><input id='sku' style='width:150px'><label>Ad</label><input id='sname' style='width:240px'><label>Miktar</label><input id='sqty' type='number' step='0.01' style='width:120px'><label>Maliyet</label><input id='scost' type='number' step='0.01' style='width:120px'><button class='primary' id='saveStok'>Kaydet</button></div><table id='stokT'></table></div></div>`;
  async function load(){const d=await api('/api/inventory/items?page=1&pageSize=200'); stokT.innerHTML='<tr><th>ID</th><th>Kod</th><th>Ad</th><th>Miktar</th><th>Maliyet</th></tr>'+d.rows.map(r=>`<tr><td>${r.id}</td><td>${esc(r.sku)}</td><td>${esc(r.name)}</td><td>${r.qty}</td><td>${r.avg_cost}</td></tr>`).join(''); if(!sku.value) sku.value=(await api('/api/codes/next?type=stock')).code; }
  saveStok.onclick=async()=>{await api('/api/inventory/items',{method:'POST',body:JSON.stringify({sku:sku.value,name:sname.value,qty:Number(sqty.value||0),avgCost:Number(scost.value||0)})}); sname.value='';sqty.value='';scost.value=''; sku.value=''; await load();};
  await load();
}
async function dispatchScreen(){screen.innerHTML=`<div class='box'><h4>İrsaliye İşlemleri</h4><div class='inner'><div class='row'><label>No</label><input id='dno' style='width:170px'><label>Cari</label><input id='dcust' style='width:150px'><label>Stok ID</label><input id='ditem' type='number' style='width:100px'><label>Miktar</label><input id='dqty' type='number' step='0.01' style='width:100px'><button class='primary' id='saveD'>Kaydet</button></div><table id='dT'></table></div></div>`;
  async function load(){const d=await api('/api/dispatch-notes?page=1&pageSize=200'); dT.innerHTML='<tr><th>ID</th><th>No</th><th>Cari</th><th>Miktar</th><th>Tür</th><th>PDF</th></tr>'+d.rows.map(r=>`<tr><td>${r.id}</td><td>${esc(r.note_no)}</td><td>${esc(r.customer_code)}</td><td>${r.qty}</td><td>${esc(r.kind)}</td><td><a target="_blank" href="/api/dispatch-notes/${r.id}/pdf">PDF</a></td></tr>`).join('');}
  saveD.onclick=async()=>{await api('/api/dispatch-notes',{method:'POST',body:JSON.stringify({noteNo:dno.value,customerCode:dcust.value,itemId:Number(ditem.value),qty:Number(dqty.value),kind:'İrsaliye'})}); dno.value='';dcust.value='';ditem.value='';dqty.value=''; await load();};
  await load();
}
async function collectionScreen(){screen.innerHTML=`<div class='box'><h4>Tahsilat Makbuzu</h4><div class='inner'><div class='row'><label>Cari</label><input id='ccust' style='width:180px'><label>Tutar</label><input id='camt' type='number' step='0.01' style='width:140px'><label>Yöntem</label><select id='cmet'><option value='cash'>Nakit</option><option value='bank'>Banka</option></select><button class='primary' id='saveC'>Kaydet</button></div><table id='cT'></table></div></div>`;
  async function load(){const d=await api('/api/collections?page=1&pageSize=200'); cT.innerHTML='<tr><th>ID</th><th>Cari</th><th>Tutar</th><th>Yöntem</th><th>Tarih</th><th>PDF</th></tr>'+d.rows.map(r=>`<tr><td>${r.id}</td><td>${esc(r.customer_code)}</td><td>${r.amount}</td><td>${esc(r.method)}</td><td>${esc(r.created_at)}</td><td><a target="_blank" href="/api/collections/${r.id}/pdf">PDF</a></td></tr>`).join('');}
  saveC.onclick=async()=>{await api('/api/collections',{method:'POST',body:JSON.stringify({customerCode:ccust.value,amount:Number(camt.value),method:cmet.value})}); ccust.value='';camt.value=''; await load();};
  await load();
}
if(name==='Cari') cariScreen();
else if(name==='Stok') stokScreen();
else if(name==='Satış') simpleList('Satış Listesi','/api/sales?page=1&pageSize=100',['id','customer_code','qty','price','status'],'/api/sales');
else if(name==='İrsaliye' || name==='Satış İrsaliyesi') dispatchScreen();
else if(name==='Tahsilat Makbuzu' || name==='Kasa') collectionScreen();
else if(name==='Raporlar') simpleList('Mizan','/api/reports/trial-balance',['account_code','dr','cr']);
else screen.innerHTML=`<div class='status'>${name} modülü aktif. Bu pencere kullanım için hazır.</div>`;
</script></body></html>
