<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTN ERP Modül</title>
  <style>
    body { margin:0; font-family:Segoe UI,Arial,sans-serif; background:#f8fafc; }
    .wrap { padding:14px; }
    .panel { background:#fff; border:1px solid #d7e1ed; border-radius:12px; padding:12px; }
    h3 { margin:0 0 12px; color:#0b3d5e; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    input,select,button,textarea { padding:8px 10px; border:1px solid #c8d4e2; border-radius:8px; }
    textarea { min-width:260px; min-height:40px; }
    button { background:#f3f7fb; cursor:pointer; }
    button.primary { background:#0b5fa1; color:#fff; border-color:#0b5fa1; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th,td { border:1px solid #d7e1ed; padding:7px; text-align:left; font-size:14px; }
    .msg { margin-top:8px; color:#065f46; font-weight:600; min-height:20px; }
  </style>
</head>
<body>
<div class="wrap"><div class="panel"><h3 id="title">Modül</h3><div id="app"></div><div class="msg" id="msg"></div></div></div>
<script>
  const params = new URLSearchParams(location.search);
  const name = params.get('name') || 'Dashboard';
  title.textContent = name + ' Modülü';
  const app = document.getElementById('app');
  const msg = document.getElementById('msg');

  function esc(v) { return String(v ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  async function api(url, options = {}) {
    const r = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
    const t = await r.text();
    const data = t ? JSON.parse(t) : {};
    if (!r.ok) throw new Error(data?.error?.reason || ('HTTP ' + r.status));
    return data;
  }
  function ok(text){ msg.textContent = text; msg.style.color = '#065f46'; }
  function fail(text){ msg.textContent = text; msg.style.color = '#b91c1c'; }

  async function renderDashboard() {
    const s = await api('/api/reports/summary');
    app.innerHTML = `<table><tr><th>Gösterge</th><th>Tutar</th></tr>
      <tr><td>Toplam Satış</td><td>${Number(s.sales).toFixed(2)} ₺</td></tr>
      <tr><td>Toplam Satınalma</td><td>${Number(s.purchases).toFixed(2)} ₺</td></tr>
      <tr><td>Toplam Tahsilat</td><td>${Number(s.collections).toFixed(2)} ₺</td></tr>
      <tr><td>Tedarikçi Ödemeleri</td><td>${Number(s.payments).toFixed(2)} ₺</td></tr>
      <tr><td>Masraflar</td><td>${Number(s.expenses).toFixed(2)} ₺</td></tr>
      <tr><td>Stok Değeri</td><td>${Number(s.stockValue).toFixed(2)} ₺</td></tr>
      <tr><td><b>Nakit Akışı</b></td><td><b>${Number(s.cashFlow).toFixed(2)} ₺</b></td></tr></table>`;
  }

  async function renderCari(type='customer') {
    app.innerHTML = `<div class="row"><input id="code" placeholder="Cari Kod" style="width:130px"><input id="cname" placeholder="Cari Adı" style="width:220px"><input id="city" placeholder="Şehir" style="width:140px"><button class="primary" id="save">Kaydet</button></div><table id="tbl"><tr><th>Kod</th><th>Ad</th><th>Şehir</th><th>Tip</th></tr></table>`;
    const load = async () => {
      const c = await api('/api/customers?page=1&pageSize=200');
      const rows = (c.rows || []).filter(r => type === 'all' ? true : (type === 'supplier' ? r.type !== 'customer' : r.type !== 'supplier'));
      tbl.innerHTML = '<tr><th>Kod</th><th>Ad</th><th>Şehir</th><th>Tip</th></tr>' + rows.map(r => `<tr><td>${esc(r.code)}</td><td>${esc(r.name)}</td><td>${esc(r.city)}</td><td>${esc(r.type)}</td></tr>`).join('');
      if (!code.value) code.value = (await api('/api/codes/next?type=customer')).code;
    };
    save.onclick = async () => {
      const payloadType = type === 'supplier' ? 'supplier' : type === 'all' ? 'both' : 'customer';
      await api('/api/customers', { method:'POST', body: JSON.stringify({ code: code.value, name: cname.value, city: city.value, type: payloadType }) });
      cname.value = ''; city.value = ''; code.value = '';
      ok('Cari kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderStok() {
    app.innerHTML = `<div class="row"><input id="sku" placeholder="Stok Kod" style="width:130px"><input id="sname" placeholder="Stok Adı" style="width:220px"><input id="qty" type="number" step="0.01" placeholder="Miktar" style="width:110px"><input id="cost" type="number" step="0.01" placeholder="Maliyet" style="width:110px"><button class="primary" id="save">Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Kod</th><th>Ad</th><th>Miktar</th><th>Maliyet</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/inventory/items?page=1&pageSize=300');
      tbl.innerHTML = '<tr><th>ID</th><th>Kod</th><th>Ad</th><th>Miktar</th><th>Maliyet</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.sku)}</td><td>${esc(r.name)}</td><td>${r.qty}</td><td>${r.avg_cost}</td></tr>`).join('');
      if (!sku.value) sku.value = (await api('/api/codes/next?type=stock')).code;
    };
    save.onclick = async () => {
      await api('/api/inventory/items', { method:'POST', body: JSON.stringify({ sku: sku.value, name: sname.value, qty: Number(qty.value || 0), avgCost: Number(cost.value || 0) }) });
      sku.value=''; sname.value=''; qty.value=''; cost.value='';
      ok('Stok kartı kaydedildi.');
      await load();
    };
    await load();
  }

  async function renderSales() {
    const d = await api('/api/sales?page=1&pageSize=200');
    app.innerHTML = `<table><tr><th>ID</th><th>Cari</th><th>Ödeme</th><th>Ara Toplam</th><th>KDV</th><th>Genel Toplam</th><th>Durum</th><th>Belge</th></tr>
    ${(d.rows||[]).map(r=>`<tr><td>${r.id}</td><td>${esc(r.customer_code)}</td><td>${esc(r.payment_method)}</td><td>${Number(r.net_total).toFixed(2)}</td><td>${Number(r.vat_total).toFixed(2)}</td><td>${Number(r.gross_total).toFixed(2)}</td><td>${esc(r.status)}</td><td><a href="/api/sales/${r.id}/pdf" target="_blank">PDF</a></td></tr>`).join('')}</table>`;
  }

  async function renderPurchases() {
    app.innerHTML = `<div class="row"><input id="supplierCode" placeholder="Tedarikçi Kod" style="width:140px"><input id="itemId" type="number" placeholder="Stok ID" style="width:110px"><input id="qty" type="number" step="0.01" placeholder="Miktar" style="width:110px"><input id="price" type="number" step="0.01" placeholder="Birim Fiyat" style="width:110px"><input id="vatRate" type="number" step="0.01" value="0.2" style="width:90px"><button class="primary" id="save">Alış Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Fatura No</th><th>Tedarikçi</th><th>Toplam</th><th>Tarih</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/purchases?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>Fatura No</th><th>Tedarikçi</th><th>Toplam</th><th>Tarih</th></tr>' + d.rows.map(r=>`<tr><td>${r.id}</td><td>${esc(r.invoice_no)}</td><td>${esc(r.supplier_code)}</td><td>${Number(r.gross_total).toFixed(2)}</td><td>${esc(r.created_at)}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/purchases', { method:'POST', body: JSON.stringify({ supplierCode: supplierCode.value, lines:[{ itemId: Number(itemId.value), qty: Number(qty.value||0), price: Number(price.value||0), vatRate: Number(vatRate.value||0) }] }) });
      supplierCode.value=''; itemId.value=''; qty.value=''; price.value='';
      ok('Satınalma kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderDispatch() {
    app.innerHTML = `<div class="row"><input id="noteNo" placeholder="İrsaliye No" style="width:140px"><input id="cust" placeholder="Cari Kod" style="width:140px"><input id="itemId" type="number" placeholder="Stok ID" style="width:100px"><input id="qty" type="number" step="0.01" placeholder="Miktar" style="width:100px"><button class="primary" id="save">Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>No</th><th>Cari</th><th>Miktar</th><th>PDF</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/dispatch-notes?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>No</th><th>Cari</th><th>Miktar</th><th>PDF</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.note_no)}</td><td>${esc(r.customer_code)}</td><td>${r.qty}</td><td><a href="/api/dispatch-notes/${r.id}/pdf" target="_blank">PDF</a></td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/dispatch-notes', { method:'POST', body: JSON.stringify({ noteNo: noteNo.value, customerCode: cust.value, itemId: Number(itemId.value), qty: Number(qty.value || 0), kind: 'İrsaliye' }) });
      noteNo.value=''; cust.value=''; itemId.value=''; qty.value='';
      ok('İrsaliye kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderCollection() {
    app.innerHTML = `<div class="row"><input id="ccode" placeholder="Cari Kod" style="width:140px"><input id="amt" type="number" step="0.01" placeholder="Tutar" style="width:120px"><select id="method"><option value="cash">Nakit</option><option value="bank">Banka</option></select><button class="primary" id="save">Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Cari</th><th>Tutar</th><th>Yöntem</th><th>PDF</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/collections?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>Cari</th><th>Tutar</th><th>Yöntem</th><th>PDF</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.customer_code)}</td><td>${Number(r.amount).toFixed(2)}</td><td>${esc(r.method)}</td><td><a href="/api/collections/${r.id}/pdf" target="_blank">PDF</a></td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/collections', { method:'POST', body: JSON.stringify({ customerCode: ccode.value, amount: Number(amt.value || 0), method: method.value }) });
      ccode.value=''; amt.value='';
      ok('Tahsilat kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderPayments() {
    app.innerHTML = `<div class="row"><input id="scode" placeholder="Tedarikçi Kod" style="width:140px"><input id="amt" type="number" step="0.01" placeholder="Tutar" style="width:120px"><select id="method"><option value="bank">Banka</option><option value="cash">Nakit</option></select><button class="primary" id="save">Ödeme Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Tedarikçi</th><th>Tutar</th><th>Yöntem</th><th>Tarih</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/payments?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>Tedarikçi</th><th>Tutar</th><th>Yöntem</th><th>Tarih</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.supplier_code)}</td><td>${Number(r.amount).toFixed(2)}</td><td>${esc(r.method)}</td><td>${esc(r.created_at)}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/payments', { method:'POST', body: JSON.stringify({ supplierCode: scode.value, amount: Number(amt.value || 0), method: method.value }) });
      scode.value=''; amt.value='';
      ok('Tedarikçi ödeme kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderExpenses() {
    app.innerHTML = `<div class="row"><input id="etype" placeholder="Masraf Türü" style="width:140px"><input id="amt" type="number" step="0.01" placeholder="Tutar" style="width:120px"><select id="method"><option value="bank">Banka</option><option value="cash">Nakit</option></select><textarea id="desc" placeholder="Açıklama"></textarea><button class="primary" id="save">Masraf Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Tür</th><th>Tutar</th><th>Yöntem</th><th>Açıklama</th><th>Tarih</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/expenses?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>Tür</th><th>Tutar</th><th>Yöntem</th><th>Açıklama</th><th>Tarih</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.expense_type)}</td><td>${Number(r.amount).toFixed(2)}</td><td>${esc(r.method)}</td><td>${esc(r.description||'')}</td><td>${esc(r.created_at)}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/expenses', { method:'POST', body: JSON.stringify({ expenseType: etype.value, amount: Number(amt.value || 0), method: method.value, description: desc.value }) });
      etype.value=''; amt.value=''; desc.value='';
      ok('Masraf kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderBank() {
    app.innerHTML = `<div class="row"><input id="bankName" placeholder="Banka" style="width:160px"><input id="iban" placeholder="IBAN" style="width:190px"><input id="amt" type="number" step="0.01" placeholder="Tutar" style="width:120px"><select id="txType"><option value="deposit">Yatırma</option><option value="withdraw">Çekme</option></select><input id="desc" placeholder="Açıklama" style="width:200px"><button class="primary" id="save">Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Banka</th><th>İşlem</th><th>Tutar</th><th>Açıklama</th><th>Tarih</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/bank-transactions?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>Banka</th><th>İşlem</th><th>Tutar</th><th>Açıklama</th><th>Tarih</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.bank_name)}</td><td>${esc(r.tx_type)}</td><td>${Number(r.amount).toFixed(2)}</td><td>${esc(r.description||'')}</td><td>${esc(r.created_at)}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/bank-transactions', { method:'POST', body: JSON.stringify({ bankName: bankName.value, iban: iban.value, txType: txType.value, amount: Number(amt.value || 0), description: desc.value }) });
      bankName.value=''; iban.value=''; amt.value=''; desc.value='';
      ok('Banka işlemi kaydedildi.');
      await load();
    };
    await load();
  }

  async function renderWarehouses() {
    app.innerHTML = `<div class="row"><input id="wcode" placeholder="Depo Kod" style="width:130px"><input id="wname" placeholder="Depo Adı" style="width:220px"><button class="primary" id="save">Depo Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>Kod</th><th>Ad</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/warehouses');
      tbl.innerHTML = '<tr><th>ID</th><th>Kod</th><th>Ad</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.code)}</td><td>${esc(r.name)}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/warehouses', { method:'POST', body: JSON.stringify({ code: wcode.value, name: wname.value }) });
      wcode.value=''; wname.value='';
      ok('Depo kaydı oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderTransfer() {
    const warehouses = await api('/api/warehouses');
    app.innerHTML = `<div class="row"><input id="itemId" type="number" placeholder="Stok ID" style="width:100px"><input id="qty" type="number" step="0.01" placeholder="Miktar" style="width:110px"><select id="fromWh">${(warehouses.rows||[]).map(r=>`<option value="${r.id}">${esc(r.code)} - ${esc(r.name)}</option>`).join('')}</select><select id="toWh">${(warehouses.rows||[]).map(r=>`<option value="${r.id}">${esc(r.code)} - ${esc(r.name)}</option>`).join('')}</select><button class="primary" id="save">Transfer Kaydet</button></div><table id="tbl"><tr><th>ID</th><th>No</th><th>Stok</th><th>Miktar</th><th>Kaynak</th><th>Hedef</th></tr></table>`;
    const load = async () => {
      const d = await api('/api/stock-transfers?page=1&pageSize=200');
      tbl.innerHTML = '<tr><th>ID</th><th>No</th><th>Stok</th><th>Miktar</th><th>Kaynak</th><th>Hedef</th></tr>' + d.rows.map(r => `<tr><td>${r.id}</td><td>${esc(r.transfer_no)}</td><td>${r.item_id}</td><td>${r.qty}</td><td>${r.from_warehouse_id}</td><td>${r.to_warehouse_id}</td></tr>`).join('');
    };
    save.onclick = async () => {
      await api('/api/stock-transfers', { method:'POST', body: JSON.stringify({ itemId: Number(itemId.value), qty: Number(qty.value||0), fromWarehouseId: Number(fromWh.value), toWarehouseId: Number(toWh.value) }) });
      itemId.value=''; qty.value='';
      ok('Depo transferi oluşturuldu.');
      await load();
    };
    await load();
  }

  async function renderReports() {
    const [mizan, sum] = await Promise.all([api('/api/reports/trial-balance'), api('/api/reports/summary')]);
    const header = '<tr><th>Hesap Kodu</th><th>Borç</th><th>Alacak</th></tr>';
    const rows = (mizan || []).map(r => `<tr><td>${esc(r.account_code)}</td><td>${Number(r.dr).toFixed(2)}</td><td>${Number(r.cr).toFixed(2)}</td></tr>`).join('');
    app.innerHTML = `<h4>Finansal Özet</h4><table><tr><th>Gösterge</th><th>Tutar</th></tr>
      <tr><td>Satış</td><td>${Number(sum.sales).toFixed(2)}</td></tr>
      <tr><td>Satınalma</td><td>${Number(sum.purchases).toFixed(2)}</td></tr>
      <tr><td>Tahsilat</td><td>${Number(sum.collections).toFixed(2)}</td></tr>
      <tr><td>Ödeme + Masraf</td><td>${(Number(sum.payments)+Number(sum.expenses)).toFixed(2)}</td></tr>
      <tr><td>Nakit Akışı</td><td>${Number(sum.cashFlow).toFixed(2)}</td></tr></table><h4>Mizan</h4><table>${header}${rows}</table>`;
  }

  const renderers = {
    'Dashboard': renderDashboard,
    'Cari': () => renderCari('customer'),
    'Tedarikçiler': () => renderCari('supplier'),
    'Stok': renderStok,
    'Depolar': renderWarehouses,
    'Depo Transfer': renderTransfer,
    'Satış': renderSales,
    'Satınalma': renderPurchases,
    'İrsaliye': renderDispatch,
    'Tahsilat Makbuzu': renderCollection,
    'Tedarikçi Ödeme': renderPayments,
    'Gider Yönetimi': renderExpenses,
    'Banka İşlemleri': renderBank,
    'Raporlar': renderReports
  };

  (async () => {
    try {
      const fn = renderers[name];
      if (!fn) {
        app.innerHTML = 'Modül tanımlı değil.';
        return;
      }
      await fn();
    } catch (e) {
      fail(e.message);
    }
  })();
</script>
</body>
</html>
